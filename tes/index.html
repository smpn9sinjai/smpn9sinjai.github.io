<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>PWA Kamera Satu File</title>
</head>
<body>
  <h2>ðŸ“· Kamera + Worker + Offline (1 file)</h2>
  <button id="startCam">Buka Kamera</button>
  <video id="video" autoplay playsinline style="width:300px; border:1px solid #ccc;"></video>
  <pre id="output"></pre>

<script>
// ==== Inline Service Worker ====
if ("serviceWorker" in navigator) {
  const swCode = `
    const CACHE_NAME = "pwa-camera-v1";
    const FILES_TO_CACHE = ["./"];
    self.addEventListener("install", e => {
      e.waitUntil(caches.open(CACHE_NAME).then(c => c.addAll(FILES_TO_CACHE)));
    });
    self.addEventListener("fetch", e => {
      e.respondWith(caches.match(e.request).then(r => r || fetch(e.request)));
    });
  `;
  const swBlob = new Blob([swCode], { type: "text/javascript" });
  const swUrl = URL.createObjectURL(swBlob);
  navigator.serviceWorker.register(swUrl).then(() => console.log("SW siap"));
}

// ==== Inline Worker ====
const workerCode = `
  onmessage = e => {
    const { size } = e.data;
    postMessage("Frame diterima, ukuran: " + size + " byte");
  };
`;
const workerBlob = new Blob([workerCode], { type: "text/javascript" });
const worker = new Worker(URL.createObjectURL(workerBlob));
worker.onmessage = e => document.getElementById("output").textContent = e.data;

// ==== Kamera ====
document.getElementById("startCam").onclick = async () => {
  const video = document.getElementById("video");
  const stream = await navigator.mediaDevices.getUserMedia({ video: true });
  video.srcObject = stream;

  // kirim frame tiap 1 detik ke worker
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");

  setInterval(() => {
    if (video.videoWidth > 0) {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);
      canvas.toBlob(blob => {
        if (blob) worker.postMessage({ size: blob.size });
      }, "image/jpeg");
    }
  }, 1000);
};
</script>
</body>
</html>
