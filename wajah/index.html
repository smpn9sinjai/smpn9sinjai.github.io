<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Rekam new Data Wajah</title>
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
</head>
<body>
  <h2>Rekam Data Wajah</h2>
  <label>Nama / NIS: <input type="text" id="nama"></label>
  <button id="start">Mulai Kamera</button>
  <button id="capture">Rekam Wajah</button>
  <button id="lihat">Lihat Data</button>

  <br><br>
  <video id="video" width="320" height="240" autoplay muted></video>
  <pre id="output"></pre>

  <script>
    const video = document.getElementById('video');
    const output = document.getElementById('output');

    // Load model
    Promise.all([
      faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
      faceapi.nets.faceLandmark68Net.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
      faceapi.nets.faceRecognitionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models')
    ]).then(() => console.log("✅ Model siap"));

    // Start kamera
    document.getElementById("start").onclick = async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
      video.srcObject = stream;
    };

    // Rekam wajah
    document.getElementById("capture").onclick = async () => {
      const detection = await faceapi
        .detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
        .withFaceLandmarks()
        .withFaceDescriptor();

      if (!detection) return alert("❌ Wajah tidak terdeteksi!");

      const nama = document.getElementById("nama").value || "Tanpa Nama";
      const descriptor = Array.from(detection.descriptor);

      let db = JSON.parse(localStorage.getItem("dbWajah")) || [];

      // Cek apakah nama sudah ada, kalau ada tambahkan descriptor
      const idx = db.findIndex(p => p.nama === nama);
      if (idx > -1) {
        db[idx].descriptors.push(descriptor);
      } else {
        db.push({ nama: nama, descriptors: [descriptor] });
      }

      localStorage.setItem("dbWajah", JSON.stringify(db));
      output.innerText = "✅ Data tersimpan!\n\n" + JSON.stringify(db, null, 2);
    };

    // Lihat semua data
    document.getElementById("lihat").onclick = () => {
      const db = JSON.parse(localStorage.getItem("dbWajah")) || [];
      output.innerText = JSON.stringify(db, null, 2);
    };
  </script>
</body>
</html>
