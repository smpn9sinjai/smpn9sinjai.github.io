<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Face Recognition Camera</title>
<script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
<style>
  body { text-align:center; font-family:Arial; }
  #video { border:3px solid blue; border-radius:12px; margin-top:15px; }
  #overlay { position:absolute; left:0; top:0; }
  #log { margin-top:10px; font-size:14px; height:180px; overflow:auto; border:1px solid #ccc; padding:5px; background:#f9f9f9; }
</style>
</head>
<body>

<h2>Face Recognition Camera</h2>
<video id="video" width="640" height="480" autoplay muted></video>
<canvas id="overlay"></canvas>
<div id="log"></div>

<script>
const MODEL_URL = "models";
const video = document.getElementById("video");
const overlay = document.getElementById("overlay");
const logBox = document.getElementById("log");

function log(msg) {
  const t = new Date().toLocaleTimeString();
  logBox.innerHTML = `[${t}] ${msg}<br>` + logBox.innerHTML;
}

// ---------------- LOAD MODELS (SSD) ----------------
async function loadModels() {
  log("Memuat model...");
  await faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL);
  await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
  await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
  log("Model selesai dimuat ✔");
  await loadLabeledFaces();
  startVideo();
}

let faceMatcher;

// ---------------- LOAD LABELED FACES ----------------
async function loadLabeledFaces() {
  log("Memuat data wajah & nama...");

  const labels = ["budi"]; // ← tambah jika ada wajah lain
  const labeledDescriptors = [];

  for (const label of labels) {
    const descriptors = [];
    for (let i = 1; i <= 3; i++) {
      const imgUrl = `labeled/${label}/${i}.jpg`;
      log("Ambil gambar: " + imgUrl);

      const img = await faceapi.fetchImage(imgUrl);
      const det = await faceapi
        .detectSingleFace(img, new faceapi.SsdMobilenetv1Options({ minConfidence: 0.5 }))
        .withFaceLandmarks()
        .withFaceDescriptor();

      if (!det) {
        log(`⚠ Wajah ${label} tidak terdeteksi — cek gambar`);
        continue;
      }
      descriptors.push(det.descriptor);
    }
    labeledDescriptors.push(new faceapi.LabeledFaceDescriptors(label, descriptors));
  }
  faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.55);
  log("Data wajah selesai dimuat ✔");
}

// ---------------- CAMERA ----------------
async function startVideo() {
  const stream = await navigator.mediaDevices.getUserMedia({ video: true });
  video.srcObject = stream;
  log("Kamera aktif");
  recognize();
}

// ---------------- RECOGNITION LOOP ----------------
async function recognize() {
  overlay.width = video.width;
  overlay.height = video.height;
  const ctx = overlay.getContext("2d");

  setInterval(async () => {
    const detections = await faceapi
      .detectAllFaces(video, new faceapi.SsdMobilenetv1Options({ minConfidence: 0.5 }))
      .withFaceLandmarks()
      .withFaceDescriptors();

    ctx.clearRect(0, 0, overlay.width, overlay.height);

    detections.forEach(det => {
      const box = det.detection.box;
      const best = faceMatcher.findBestMatch(det.descriptor);

      ctx.beginPath();
      ctx.lineWidth = 3;
      ctx.strokeStyle = best.label === "unknown" ? "red" : "lime";
      ctx.rect(box.x, box.y, box.width, box.height);
      ctx.stroke();

      ctx.fillStyle = "black";
      ctx.font = "20px Arial";
      ctx.fillText(best.toString(), box.x, box.y - 10);
    });
  }, 300);
}

// START
loadModels();
</script>
</body>
</html>
