<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pengenalan Wajah Real-Time (Satu File)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/face-api.js"></script>

    <style>
        /* CSS Dasar */
        body { 
            margin: 0; 
            display: flex; 
            flex-direction: column;
            justify-content: center; 
            align-items: center; 
            min-height: 100vh;
            font-family: sans-serif;
            background-color: #f4f4f9;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .video-container { 
            position: relative; 
            border: 4px solid #007bff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        video {
            display: block;
            border-radius: 4px;
        }
        canvas { 
            position: absolute; 
            top: 0; 
            left: 0; 
        }
        #loading-message {
            margin-top: 15px;
            font-size: 1.1em;
            color: #ff6f00;
        }
    </style>
</head>
<body>
    <h1>Deteksi & Pengenalan Wajah Real-Time</h1>
    <div id="loading-message">Memuat model Machine Learning... Mohon Tunggu.</div>
    
    <div class="video-container">
        <video id="video" width="640" height="480" autoplay muted></video>
        </div>

    <script>
        // Logika JavaScript untuk Pengenalan Wajah

        const video = document.getElementById('video');
        const loadingMessage = document.getElementById('loading-message');
        let faceMatcher; // Variabel untuk menyimpan deskriptor wajah yang dikenal

        // 1. Memuat Model
        // Pastikan folder 'models' ada di direktori yang sama!
        Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri('/models'),
            faceapi.nets.faceLandmark68Net.loadFromUri('/models'),
            faceapi.nets.faceRecognitionNet.loadFromUri('/models')
        ]).then(initializeApp).catch(err => {
            loadingMessage.textContent = 'Gagal memuat model. Pastikan folder /models sudah benar!';
            console.error('Error loading models:', err);
        });

        async function initializeApp() {
            loadingMessage.textContent = 'Model berhasil dimuat. Melakukan pelatihan data wajah...';
            
            // 2. Pelatihan/Mendefinisikan Wajah yang Dikenal
            try {
                faceMatcher = await loadLabeledImages();
                loadingMessage.textContent = 'Pelatihan selesai. Memulai kamera...';
                startVideo();
            } catch (error) {
                loadingMessage.textContent = 'Gagal memuat atau melatih gambar wajah. Pastikan folder /images sudah benar!';
                console.error('Error training faces:', error);
            }
        }

        // 3. Akses Webcam
        function startVideo() {
            navigator.mediaDevices.getUserMedia(
                { video: {} }
            ).then(stream => {
                video.srcObject = stream;
            }).catch(err => {
                loadingMessage.textContent = 'Akses kamera ditolak atau gagal. Coba di browser lain atau pastikan izin kamera diberikan.';
                console.error('Error accessing camera:', err);
            });
        }

        // Setelah video dimuat, mulai deteksi
        video.addEventListener('play', () => {
            loadingMessage.textContent = 'Deteksi wajah berjalan secara real-time.';

            // Membuat canvas untuk menggambar hasil deteksi
            const canvas = faceapi.createCanvasFromMedia(video);
            document.querySelector('.video-container').append(canvas);
            const displaySize = { width: video.width, height: video.height };
            faceapi.matchDimensions(canvas, displaySize);
            
            // 4. Deteksi Wajah Real-Time
            setInterval(async () => {
                const detections = await faceapi.detectAllFaces(
                    video, 
                    new faceapi.TinyFaceDetectorOptions()
                )
                    .withFaceLandmarks()
                    .withFaceDescriptors(); // Ekstraksi Fitur
                
                const resizedDetections = faceapi.resizeResults(detections, displaySize);
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);

                // 5. Pengenalan Wajah
                if (faceMatcher) {
                    const results = resizedDetections.map(d => 
                        faceMatcher.findBestMatch(d.descriptor)
                    );
    
                    results.forEach((bestMatch, i) => {
                        const box = resizedDetections[i].detection.box;
                        // Teks akan berupa nama atau "unknown"
                        const text = bestMatch.toString(); 
                        const drawBox = new faceapi.draw.DrawBox(box, { label: text });
                        drawBox.draw(canvas);
                    });
                } else {
                    // Jika faceMatcher belum siap, gambar saja kotak deteksi
                    faceapi.draw.drawDetections(canvas, resizedDetections);
                }

            }, 100); // Lakukan deteksi setiap 100ms
        });

        // FUNGSI KRITIS: Memuat dan Melatih Data Wajah
        function loadLabeledImages() {
            // Ubah list ini sesuai dengan nama folder dan orang yang ingin Anda kenali!
            const labels = ['Budi', 'Ani', 'Charlie']; 
            const MAX_IMAGES_PER_LABEL = 2; // Sesuaikan dengan jumlah gambar per folder (e.g., 1.jpg, 2.jpg)

            return Promise.all(
                labels.map(async label => {
                    const descriptors = [];
                    for (let i = 1; i <= MAX_IMAGES_PER_LABEL; i++) {
                        // Pastikan path ini benar: images/NamaOrang/nomor.jpg
                        const imageUrl = `images/${label}/${i}.jpg`;
                        try {
                            const img = await faceapi.fetchImage(imageUrl);
                            const fullFaceDescription = await faceapi.detectSingleFace(img)
                                .withFaceLandmarks()
                                .withFaceDescriptor();
    
                            if (fullFaceDescription) {
                                descriptors.push(fullFaceDescription.descriptor);
                            } else {
                                console.warn(`Wajah tidak terdeteksi pada ${imageUrl}`);
                            }
                        } catch (e) {
                            console.error(`Gagal memuat gambar ${imageUrl}:`, e);
                        }
                    }
                    
                    if (descriptors.length === 0) {
                        console.error(`Tidak ada deskriptor wajah yang berhasil dimuat untuk ${label}.`);
                    }

                    // Ambang batas (threshold) 0.6 adalah nilai standar untuk akurasi
                    return new faceapi.LabeledFaceDescriptors(label, descriptors);
                })
            ).then(labeledFaceDescriptors => 
                // Filter descriptor yang kosong
                labeledFaceDescriptors.filter(d => d.descriptors.length > 0)
            ).then(validLabeledFaceDescriptors => 
                new faceapi.FaceMatcher(validLabeledFaceDescriptors, 0.6)
            );
        }
    </script>
</body>
</html>
