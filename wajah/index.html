<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Deteksi Wajah + Simpan Nama (Face Recognition)</title>
  <style>
    body { font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; padding: 12px; }
    h1 { font-size: 18px; margin-bottom: 8px }
    #container { display:flex; gap:12px; align-items:flex-start }
    #videoWrap { position:relative; width:640px; max-width:100%; }
    video { width:100%; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.12); }
    canvas { position:absolute; left:0; top:0; }
    .controls { width:320px; max-width:40%; }
    input, button, select { width:100%; padding:8px; margin-top:6px; box-sizing:border-box }
    .small { font-size:13px }
    ul { padding-left:16px }
    .hint { font-size:13px; color:#555 }
  </style>
</head>
<body>
  <h1>Deteksi Wajah &amp; Simpan Nama — Demo HTML</h1>
  <p class="hint">Buka akses kamera saat diminta. Arahkan wajah ke kamera, masukkan nama lalu tekan <strong>Save</strong> untuk menyimpan embedding wajah ke <code>localStorage</code>.</p>

  <div id="container">
    <div id="videoWrap">
      <video id="video" autoplay muted></video>
      <canvas id="overlay"></canvas>
    </div>

    <div class="controls">
      <label class="small">Nama (untuk simpan wajah):</label>
      <input id="nameInput" placeholder="Contoh: Budi" />
      <button id="saveBtn">Save (simpan wajah saat muncul)</button>
      <button id="clearDb">Clear Database</button>

      <label class="small" style="margin-top:10px">Daftar wajah tersimpan:</label>
      <ul id="labelList"></ul>

      <label class="small" style="margin-top:10px">Ekspor / Impor DB (JSON)</label>
      <button id="exportBtn">Export JSON</button>
      <input type="file" id="importFile" accept="application/json" />

      <p class="hint" style="margin-top:8px">Threshold pencocokan default: 0.6 (lebih rendah = lebih ketat). Anda dapat mengubahnya di kode jika perlu.</p>
    </div>
  </div>

  <!-- face-api.js dari CDN -->
  <script src="https://unpkg.com/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <script>
    const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models'
    const video = document.getElementById('video')
    const overlay = document.getElementById('overlay')
    const ctx = overlay.getContext('2d')
    const nameInput = document.getElementById('nameInput')
    const saveBtn = document.getElementById('saveBtn')
    const clearDbBtn = document.getElementById('clearDb')
    const labelList = document.getElementById('labelList')
    const exportBtn = document.getElementById('exportBtn')
    const importFile = document.getElementById('importFile')

    const LOCAL_KEY = 'face_db_v1'
    let labeledDescriptors = [] // array of faceapi.LabeledFaceDescriptors
    let faceMatcher = null
    let detecting = false

    async function loadModels() {
      // muat model yang diperlukan
      await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL)
      await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL)
      await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
      // optional: expression / age gender jika ingin
    }

    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: {} , audio: false })
        video.srcObject = stream
        return new Promise(res => video.onloadedmetadata = res)
      } catch (e) {
        alert('Gagal akses kamera: ' + e.message)
      }
    }

    function resizeCanvasToVideo(){
      overlay.width = video.videoWidth
      overlay.height = video.videoHeight
    }

    // muat DB dari localStorage
    function loadDB(){
      const raw = localStorage.getItem(LOCAL_KEY)
      if (!raw) return []
      try {
        const parsed = JSON.parse(raw)
        // parsed: [{name: 'Budi', descriptors: [[...], ...]}, ...]
        const arr = parsed.map(item => {
          const descs = item.descriptors.map(d => new Float32Array(d))
          return new faceapi.LabeledFaceDescriptors(item.name, descs)
        })
        labeledDescriptors = arr
      } catch (e) {
        console.error('Gagal parse DB', e)
        labeledDescriptors = []
      }
      rebuildMatcher()
      refreshLabelList()
    }

    function saveDB(){
      const toSave = labeledDescriptors.map(ld => ({ name: ld.label, descriptors: ld.descriptors.map(d => Array.from(d)) }))
      localStorage.setItem(LOCAL_KEY, JSON.stringify(toSave))
      refreshLabelList()
    }

    function rebuildMatcher(){
      if (labeledDescriptors.length === 0) { faceMatcher = null; return }
      faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.6) // threshold 0.6
    }

    function refreshLabelList(){
      labelList.innerHTML = ''
      labeledDescriptors.forEach(ld => {
        const li = document.createElement('li')
        li.textContent = `${ld.label} — ${ld.descriptors.length} sampel`
        labelList.appendChild(li)
      })
    }

    async function detectLoop(){
      if (!video || video.readyState !== 4) { requestAnimationFrame(detectLoop); return }
      if (!detecting) { requestAnimationFrame(detectLoop); return }

      const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 })
      const detections = await faceapi.detectAllFaces(video, options).withFaceLandmarks().withFaceDescriptors()

      resizeCanvasToVideo()
      ctx.clearRect(0,0,overlay.width, overlay.height)

      if (detections && detections.length > 0){
        detections.forEach(det => {
          const box = det.detection.box
          const descriptor = det.descriptor

          // gambar kotak
          ctx.lineWidth = 2
          ctx.strokeStyle = '#00FF00'
          ctx.strokeRect(box.x, box.y, box.width, box.height)

          let text = 'Unknown'
          if (faceMatcher){
            const best = faceMatcher.findBestMatch(descriptor)
            text = best.toString() // nama (distance)
          }

          // label
          ctx.fillStyle = '#00FF00'
          ctx.font = '16px sans-serif'
          ctx.fillText(text, box.x, Math.max(20, box.y - 6))
        })
      }

      requestAnimationFrame(detectLoop)
    }

    // simpan descriptor saat tombol Save
    saveBtn.addEventListener('click', async ()=>{
      const name = nameInput.value.trim()
      if (!name) { alert('Masukkan nama dulu'); return }
      // deteksi sekali wajah terbaik
      const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 })
      const detection = await faceapi.detectSingleFace(video, options).withFaceLandmarks().withFaceDescriptor()
      if (!detection) { alert('Tidak menemukan wajah di kamera. Pastikan wajah terlihat jelas.'); return }
      const descriptor = detection.descriptor

      // cari label yang sama
      const existing = labeledDescriptors.find(ld => ld.label === name)
      if (existing) {
        existing.descriptors.push(descriptor)
      } else {
        labeledDescriptors.push(new faceapi.LabeledFaceDescriptors(name, [descriptor]))
      }
      saveDB()
      rebuildMatcher()
      alert('Wajah tersimpan untuk: ' + name)
    })

    clearDbBtn.addEventListener('click', ()=>{
      if (!confirm('Hapus seluruh database wajah yang tersimpan di localStorage?')) return
      localStorage.removeItem(LOCAL_KEY)
      labeledDescriptors = []
      rebuildMatcher()
      refreshLabelList()
    })

    exportBtn.addEventListener('click', ()=>{
      const raw = localStorage.getItem(LOCAL_KEY) || '[]'
      const blob = new Blob([raw], {type:'application/json'})
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url; a.download = 'face_db.json'; a.click()
      URL.revokeObjectURL(url)
    })

    importFile.addEventListener('change', (e)=>{
      const f = e.target.files[0]
      if (!f) return
      const fr = new FileReader()
      fr.onload = function(){
        try {
          const parsed = JSON.parse(fr.result)
          // validate minimal
          if (!Array.isArray(parsed)) throw new Error('Format tidak valid')
          localStorage.setItem(LOCAL_KEY, JSON.stringify(parsed))
          loadDB()
          alert('Impor selesai')
        } catch (err){ alert('Gagal impor: '+err.message) }
      }
      fr.readAsText(f)
    })

    // inisialisasi
    (async ()=>{
      await loadModels()
      await startCamera()
      loadDB()
      // mulai deteksi otomatis
      detecting = true
      detectLoop()
    })()

  </script>
</body>
</html>
