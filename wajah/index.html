<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Face Recognition</title>
<style>
  body { font-family: Arial; text-align: center; background: #f3f3f3; }
  video { border: 3px solid #222; border-radius: 6px; margin-top: 10px; }
  canvas { position: absolute; left: 0; top: 0; }
  #log { margin-top: 10px; background: white; border: 1px solid #aaa; padding: 10px; width: 90%; height: 150px; overflow-y: auto; display: inline-block; text-align: left; }
</style>
<script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
</head>
<body>

<h2>üîç Sistem Pengenalan Wajah</h2>
<video id="video" width="420" height="320" autoplay muted></video>
<canvas id="overlay"></canvas>

<div id="log"></div>

<script>
const MODEL_URL = "https://smpn9sinjai.sch.id/wajah/models";
const BASE_URL = "https://smpn9sinjai.sch.id/wajah";
const LABELS = ["budi"]; // tambah nama folder lain jika ada

function log(t) {
  document.getElementById("log").innerHTML += `[${new Date().toLocaleTimeString()}] ${t}<br>`;
  document.getElementById("log").scrollTop = document.getElementById("log").scrollHeight;
}

async function loadModels() {
  log("Memuat model...");
  await faceapi.loadTinyFaceDetectorModel(MODEL_URL);
  await faceapi.loadFaceLandmarkModel(MODEL_URL);
  await faceapi.loadFaceRecognitionModel(MODEL_URL);
  log("Model selesai dimuat ‚úî");
}

async function loadLabeledFaces() {
  log("Memuat data wajah & nama...");
  const labeledDescriptors = [];

  for (const label of LABELS) {
    const imgURL = `${BASE_URL}/labeled/${label}/1.jpg`;
    log("Ambil gambar: " + imgURL);

    const img = await faceapi.fetchImage(imgURL);

    const det = await faceapi
      .detectSingleFace(img, new faceapi.TinyFaceDetectorOptions({ inputSize: 416 }))
      .withFaceLandmarks()
      .withFaceDescriptor();

    if (!det) {
      log(`‚ö† Wajah ${label} tidak terdeteksi ‚Äî cek gambar`);
      continue;
    }

    labeledDescriptors.push(
      new faceapi.LabeledFaceDescriptors(label, [det.descriptor])
    );
    log(`‚úî Data wajah tersimpan: ${label}`);
  }

  return new faceapi.FaceMatcher(labeledDescriptors, 0.6);
}

async function startVideo() {
  const video = document.getElementById("video");
  const stream = await navigator.mediaDevices.getUserMedia({ video: true });
  video.srcObject = stream;
}

async function startRecognition() {
  await loadModels();
  const faceMatcher = await loadLabeledFaces();
  await startVideo();

  const video = document.getElementById("video");
  const canvas = document.getElementById("overlay");
  const displaySize = { width: video.width, height: video.height };
  faceapi.matchDimensions(canvas, displaySize);

  video.addEventListener("playing", async () => {
    log("üé• Kamera aktif ‚Äî mulai deteksi");
    setInterval(async () => {
      const detections = await faceapi
        .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 416 }))
        .withFaceLandmarks()
        .withFaceDescriptors();

      const resized = faceapi.resizeResults(detections, displaySize);
      canvas.getContext("2d").clearRect(0, 0, canvas.width, canvas.height);

      for (const det of resized) {
        const best = faceMatcher.findBestMatch(det.descriptor);
        const box = det.detection.box;
        const drawBox = new faceapi.draw.DrawBox(box, { label: best.toString() });
        drawBox.draw(canvas);
      }
    }, 300);
  });
}

startRecognition();
</script>
</body>
</html>
