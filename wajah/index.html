<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Perekaman Data Wajah</title>
  <!-- Gunakan versi UMD agar faceapi terdefinisi -->
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
</head>
<body>
  <h2>Rekam Wajah 5 Siswa</h2>
  <label>Nama / NIS: <input type="text" id="nama"></label>
  <button id="start">Mulai Kamera</button>
  <button id="capture">Rekam Wajah</button>

  <br><br>
  <video id="video" width="320" height="240" autoplay muted></video>

  <pre id="output"></pre>

  <script>
    const video = document.getElementById('video');
    const output = document.getElementById('output');

    // Load model dari GitHub
    Promise.all([
      faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
      faceapi.nets.faceLandmark68Net.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
      faceapi.nets.faceRecognitionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models')
    ]).then(() => console.log("✅ Model siap"));

    // Start kamera
    document.getElementById("start").onclick = async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        console.log("✅ Kamera aktif");
      } catch (err) {
        console.error("❌ Kamera gagal:", err);
        alert("Tidak bisa membuka kamera: " + err.message);
      }
    };

    // Capture wajah & simpan ke localStorage
    document.getElementById("capture").onclick = async () => {
      const detections = await faceapi
        .detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
        .withFaceLandmarks()
        .withFaceDescriptor();

      if (!detections) {
        alert("Wajah tidak terdeteksi, coba lagi!");
        return;
      }

      const nama = document.getElementById("nama").value || "Tanpa Nama";
      const descriptor = Array.from(detections.descriptor);

      let db = JSON.parse(localStorage.getItem("dbWajah")) || [];
      db.push({ nama: nama, descriptor: descriptor });
      localStorage.setItem("dbWajah", JSON.stringify(db));

      output.innerText = "Data tersimpan!\n\n" + JSON.stringify(db, null, 2);
    };
  </script>
</body>
</html>
