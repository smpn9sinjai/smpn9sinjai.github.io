<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Face Recognition - SSD Fast</title>
<script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
<style>
  body { text-align:center; font-family:Arial; background:#f4f7ff; }
  #video { border:4px solid #4a6cf7; border-radius:12px; margin-top:20px; }
  #status { margin-top:15px; font-weight:bold; }
</style>
</head>
<body>

<h2>üîç Face Recognition (SsdMobilenetv1 Optimized)</h2>
<video id="video" width="640" height="480" autoplay muted></video>
<canvas id="overlay"></canvas>
<div id="status">Loading models...</div>

<script>
const video = document.getElementById("video");
const overlay = document.getElementById("overlay");
const status = document.getElementById("status");
let labeledDescriptors = [];
let faceMatcher;

// ---------------- Load Models ----------------
async function loadModels() {
  await Promise.all([
    faceapi.nets.ssdMobilenetv1.loadFromUri("./models"),
    faceapi.nets.faceLandmark68Net.loadFromUri("./models"),
    faceapi.nets.faceRecognitionNet.loadFromUri("./models")
  ]);
  status.textContent = "Model loaded ‚úì, loading faces...";
  await loadLabeledFaces();
  status.textContent = "Ready ‚úì Look at the camera";
  startCamera();
}

// ------------ Load Faces from folder ------------
async function loadLabeledFaces() {
  const names = ["budi"]; // ‚Üê ganti sesuai folder wajah labeled
  for (let name of names) {
    const descriptors = [];
    for (let i = 1; i <= 3; i++) {
      const imgUrl = `./labeled/${name}/${i}.jpg`;
      const img = await faceapi.fetchImage(imgUrl);
      const det = await faceapi
        .detectSingleFace(img)
        .withFaceLandmarks()
        .withFaceDescriptor();
      if (det) descriptors.push(det.descriptor);
    }
    labeledDescriptors.push(new faceapi.LabeledFaceDescriptors(name, descriptors));
  }
  faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.55);
}

// --------------- Start Camera ----------------
async function startCamera() {
  const stream = await navigator.mediaDevices.getUserMedia({
    video: { width: 640, height: 480 }
  });
  video.srcObject = stream;
  recognize();
}

// --------------- Recognition Loop ---------------
function recognize() {
  const ctx = overlay.getContext("2d");
  overlay.width = video.width;
  overlay.height = video.height;

  setInterval(async () => {
    const detections = await faceapi
      .detectAllFaces(video, new faceapi.SsdMobilenetv1Options({ minConfidence: 0.5 }))
      .withFaceLandmarks()
      .withFaceDescriptors();

    ctx.clearRect(0, 0, overlay.width, overlay.height);

    detections.forEach(det => {
      const best = faceMatcher.findBestMatch(det.descriptor);
      const box = det.detection.box;

      ctx.beginPath();
      ctx.lineWidth = 3;
      ctx.strokeStyle = best.label === "unknown" ? "red" : "lime";
      ctx.rect(box.x, box.y, box.width, box.height);
      ctx.stroke();

      ctx.fillStyle = "black";
      ctx.font = "20px Arial";
      ctx.fillText(best.toString(), box.x, box.y - 5);
    });

  }, 300); // deteksi 3x per detik ‚Üí cepat & tidak lag
}

// Start
loadModels();
</script>
</body>
</html>
