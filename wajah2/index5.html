<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Absensi Wajah Anti Foto</title>
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <style>
    video { width: 420px; border:1px solid black; }
    canvas { position:absolute; left:0; top:0; }
  </style>
</head>
<body>
<h3>Absensi Wajah â€” Verifikasi Gerak Kepala</h3>

<div style="position:relative;">
  <video id="cam" autoplay muted></video>
  <canvas id="canvas"></canvas>
</div>

<div id="log" style="margin-top:20px; font-size:18px; color:green;"></div>

<script>
const video = document.getElementById("cam");
const canvas = document.getElementById("canvas");
const log = document.getElementById("log");

let matcher;
let absensi = {};        // anti absen ulang
let posisi_awal = null;  // untuk deteksi arah kepala
let waktu_awal = null;   // time detection 2 detik batas
let sedang_verifikasi = false;

/* -----------------------------
   SIMPAN ABSENSI
------------------------------*/
function absen(nama) {
  if (absensi[nama]) return;
  absensi[nama] = true;
  log.innerHTML = "âœ” Absensi berhasil untuk: <b>" + nama + "</b>";
  console.log("ABSEN:", nama);
}

/* -----------------------------
   DETEKSI LOOP
------------------------------*/
async function scan() {
  const detections = await faceapi
    .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
    .withFaceLandmarks()
    .withFaceDescriptors();

  const ctx = canvas.getContext("2d");
  ctx.clearRect(0,0,canvas.width,canvas.height);

  detections.forEach(det => {
    const box = det.detection.box;
    const best = matcher.findBestMatch(det.descriptor);

    // gambar kotak
    ctx.strokeStyle = "lime";
    ctx.lineWidth = 3;
    ctx.strokeRect(box.x, box.y, box.width, box.height);

    // nama
    ctx.fillStyle = "lime";
    ctx.font = "18px Arial";
    ctx.fillText(best.label, box.x + 5, box.y - 10);

    // hanya jika orang dikenali
    if (best.label !== "unknown") {
      deteksiGerakKepala(best.label, det);
    }
  });

  requestAnimationFrame(scan);
}

/* -----------------------------
   DETEKSI GERAK KEPALA
------------------------------*/
function deteksiGerakKepala(nama, det) {
  const yaw = det.landmarks._positions[30].x; // titik hidung X

  // mulai verifikasi
  if (!sedang_verifikasi) {
    posisi_awal = yaw;
    waktu_awal = Date.now();
    sedang_verifikasi = true;
    log.innerHTML = "â†” Silahkan gerakkan kepala ke KIRI lalu ke KANAN";
    return;
  }

  // batasi waktu 2 detik
  if (Date.now() - waktu_awal > 2000) {
    sedang_verifikasi = false;
    log.innerHTML = "âŒ Verifikasi gagal â€” ulangi gerakan kepala";
    return;
  }

  const pergeseran = yaw - posisi_awal;

  // jika bergerak cukup jauh (anti foto)
  if (Math.abs(pergeseran) > 20) {
    sedang_verifikasi = false;
    absen(nama);
  }
}

/* -----------------------------
   MULAI SISTEM
------------------------------*/
async function start() {
  log.innerHTML = "â³ Loading model...";
  await Promise.all([
    faceapi.nets.tinyFaceDetector.loadFromUri("models"),
    faceapi.nets.faceLandmark68Net.loadFromUri("models"),
    faceapi.nets.faceRecognitionNet.loadFromUri("models")
  ]);

  log.innerHTML = "â³ Loading data wajah..";
  const data = await fetch("faces.json").then(r => r.json());
  const labeled = data.map(p => new faceapi.LabeledFaceDescriptors(
    p.name,
    p.descriptors.map(d => new Float32Array(d))
  ));
  matcher = new faceapi.FaceMatcher(labeled, 0.45);

  log.innerHTML = "ðŸ“· Mengaktifkan kamera...";
  navigator.mediaDevices.getUserMedia({ video:{ width:720, height:480 } })
    .then(stream => {
      video.srcObject = stream;
      video.onplaying = () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        log.innerHTML = "ðŸ”¥ Sistem siap â€” tampilkan wajah untuk absensi";
        scan();
      };
    });
}

start();
</script>
</body>
</html>
