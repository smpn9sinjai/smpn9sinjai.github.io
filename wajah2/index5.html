<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Absensi Wajah Aman</title>
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

  <style>
    body { font-family: Arial; text-align: center; }
    video { width: 420px; border:2px solid black; border-radius: 8px; }
    canvas { position:absolute; left:0; top:0; }
    #status { font-size:22px; margin-top:12px; font-weight:bold; }
  </style>
</head>
<body>

  <h2>Absensi Wajah – Anti Foto</h2>

  <div style="position:relative; display:inline-block;">
    <video id="cam" autoplay muted></video>
    <canvas id="canvas"></canvas>
  </div>

  <div id="status">Mempersiapkan kamera...</div>

<script>
const video = document.getElementById("cam");
const canvas = document.getElementById("canvas");
const status = document.getElementById("status");

let matcher;
let mouthHistory = [];
let recognizedUser = "";
let livenessPassed = false;

/* ------------------------
    Hitung jarak bibir
-------------------------*/
function mouthDistance(landmarks) {
  const mouth = landmarks.getMouth();
  const upper = mouth[13];
  const lower = mouth[14];
  return Math.abs(lower.y - upper.y);
}

/* ------------------------
    Simpan Absensi
-------------------------*/
function absen(nama) {
  const key = "absen_" + nama;
  if (localStorage.getItem(key)) return;
  localStorage.setItem(key, new Date().toLocaleString());
  status.innerHTML = "✔ Absensi berhasil untuk: <b>" + nama + "</b>";
  console.log("ABSEN UNTUK:", nama);
}

/* ------------------------
    Mulai Sistem
-------------------------*/
async function start() {
  status.innerText = "Memuat model AI...";
  await faceapi.nets.tinyFaceDetector.loadFromUri("models");
  await faceapi.nets.faceLandmark68Net.loadFromUri("models");
  await faceapi.nets.faceRecognitionNet.loadFromUri("models");

  const data = await fetch("faces.json").then(r => r.json());
  const labeled = data.map(p =>
    new faceapi.LabeledFaceDescriptors(
      p.name,
      p.descriptors.map(d => new Float32Array(d))
    )
  );

  matcher = new faceapi.FaceMatcher(labeled, 0.45);
  status.innerText = "Mengaktifkan kamera...";

  navigator.mediaDevices.getUserMedia({ video:true })
    .then(stream => video.srcObject = stream);
}

video.addEventListener("playing", () => {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  status.innerText = "Arahkan wajah ke kamera...";

  setInterval(async () => {
    const detections = await faceapi.detectAllFaces(
      video, new faceapi.TinyFaceDetectorOptions()
    ).withFaceLandmarks().withFaceDescriptors();

    const ctx = canvas.getContext("2d");
    ctx.clearRect(0,0,canvas.width,canvas.height);

    detections.forEach(det => {
      const box = det.detection.box;
      const best = matcher.findBestMatch(det.descriptor);
      const landmarks = det.landmarks;

      ctx.strokeStyle = "lime";
      ctx.lineWidth = 3;
      ctx.strokeRect(box.x, box.y, box.width, box.height);

      ctx.fillStyle = "lime";
      ctx.font = "18px Arial";
      ctx.fillText(best.label, box.x + 5, box.y - 10);

      if (best.label === "unknown") {
        status.innerText = "Wajah tidak dikenal!";
        return;
      }

      // Jika nama pertama kali terdeteksi
      if (!recognizedUser) {
        recognizedUser = best.label;
        status.innerText = "Halo " + recognizedUser + ", gerakkan mulut seperti sedang bicara...";
      }

      // Deteksi gerak mulut
      const d = mouthDistance(landmarks);
      mouthHistory.push(d);
      if (mouthHistory.length > 15) mouthHistory.shift();

      const maxD = Math.max(...mouthHistory);
      const minD = Math.min(...mouthHistory);

      if (maxD - minD > 11) livenessPassed = true;

      if (recognizedUser && livenessPassed) {
        absen(recognizedUser);
      }
    });

  }, 250);

});

start();
</script>
</body>
</html>
