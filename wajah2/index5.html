<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Generator faces.json dari Kamera</title>
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

<style>
  body { font-family: Arial; padding:20px; }
  video { width:300px; border:2px solid #444; }
  canvas { display:none; }
  #list img { width:100px; margin:5px; border:1px solid #999; }
</style>
</head>
<body>

<h2>Generator faces.json dari Kamera</h2>

<label>Nama Siswa:</label>
<input type="text" id="nama" style="font-size:16px"><br><br>

<video id="cam" autoplay muted></video><br>
<button onclick="capture()">ðŸ“¸ Capture Wajah</button>
<button onclick="simpan()">ðŸ’¾ Simpan Ke faces.json</button>

<h3>Foto yang tersimpan untuk siswa ini:</h3>
<div id="list"></div>

<hr>
<h3>Data JSON:</h3>
<pre id="output" style="background:#eee;padding:10px;white-space:pre-wrap;"></pre>

<button onclick="downloadJSON()">â¬‡ Download faces.json</button>

<canvas id="canvas"></canvas>

<script>
let video = document.getElementById("cam");
let canvas = document.getElementById("canvas");
let list = document.getElementById("list");
let output = document.getElementById("output");

let semuaData = [];         // hasil akhir semua siswa
let fotoSiswa = [];         // kumpulan descriptor 1 siswa

/* ------------------------------
   START CAMERA
--------------------------------*/
navigator.mediaDevices.getUserMedia({ video: {
    width: { ideal: 720 },
    height: { ideal: 480 }
  } }).then(stream=>{
  video.srcObject = stream;
});

/* ------------------------------
   LOAD MODEL
--------------------------------*/
async function loadModels() {
  await Promise.all([
    faceapi.nets.tinyFaceDetector.loadFromUri("models"),
    faceapi.nets.faceLandmark68Net.loadFromUri("models"),
    faceapi.nets.faceRecognitionNet.loadFromUri("models")
  ]);
}
loadModels();

/* ------------------------------
   CAPTURE WAJAH
--------------------------------*/
async function capture() {
  const nama = document.getElementById("nama").value.trim();
  if (!nama) return alert("Isi nama siswa dulu!");

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(video, 0, 0);

  // tampilkan foto kecil
  const imgUrl = canvas.toDataURL();
  const img = document.createElement("img");
  img.src = imgUrl;
  list.appendChild(img);

  // deteksi wajah
  const det = await faceapi
    .detectSingleFace(canvas, new faceapi.TinyFaceDetectorOptions())
    .withFaceLandmarks()
    .withFaceDescriptor();

  if (!det) {
    alert("Wajah tidak terdeteksi! Coba lagi.");
    return;
  }

  // bulatkan descriptor 2 angka
  const rounded = Array.from(det.descriptor).map(n => Number(n.toFixed(2)));

  fotoSiswa.push(rounded);
  alert("Foto wajah tersimpan!");
}

/* ------------------------------
   SIMPAN SATU SISWA
--------------------------------*/
function simpan() {
  const nama = document.getElementById("nama").value.trim();
  if (!nama) return alert("Isi nama siswa dulu!");
  if (fotoSiswa.length === 0) return alert("Ambil minimal 1 foto dulu!");

  semuaData.push({
    name: nama,
    descriptors: fotoSiswa
  });

  output.textContent = JSON.stringify(semuaData, null, 2);

  alert("Siswa tersimpan! Data siap ditambah siswa berikutnya.");
  
  // reset untuk siswa berikutnya
  fotoSiswa = [];
  list.innerHTML = "";
  document.getElementById("nama").value = "";
}

/* ------------------------------
   DOWNLOAD JSON
--------------------------------*/
function downloadJSON() {
  const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(semuaData));
  const a = document.createElement("a");
  a.href = dataStr;
  a.download = "faces.json";
  a.click();
}
</script>

</body>
</html>
