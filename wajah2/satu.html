<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Absensi Wajah + Kedip Mata</title>

<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

<style>
body { font-family: Arial; }
video { width:420px; border:2px solid #333; }
canvas { position:absolute; top:0; left:0; }
#log { margin-top:15px; font-size:18px; color:green; }
</style>
</head>

<body>

<h3>Absensi Wajah (Wajib Kedip Mata)</h3>

<div style="position:relative;">
  <video id="cam" autoplay muted></video>
  <canvas id="canvas"></canvas>
</div>

<div id="log">‚è≥ Memuat sistem...</div>

<script>
/* ===============================
   VAR GLOBAL
================================ */
const video = document.getElementById("cam");
const canvas = document.getElementById("canvas");
const log = document.getElementById("log");

let matcher;
let absensi = {};

let eyeCloseCount = 0;
let blinked = false;

/* ===============================
   FUNGSI ABSENSI
================================ */
function absen(nama) {
  if (absensi[nama]) return;
  absensi[nama] = true;
  log.innerHTML = "‚úî Absensi BERHASIL: <b>" + nama + "</b>";
  console.log("ABSEN:", nama);
}

/* ===============================
   UTIL KEDIP
================================ */
function distance(p1, p2) {
  return Math.hypot(p1.x - p2.x, p1.y - p2.y);
}

function eyeEAR(eye) {
  const A = distance(eye[1], eye[5]);
  const B = distance(eye[2], eye[4]);
  const C = distance(eye[0], eye[3]);
  return (A + B) / (2 * C);
}

/* ===============================
   LOOP DETEKSI
================================ */
async function scan() {
  const detections = await faceapi
    .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
    .withFaceLandmarks()
    .withFaceDescriptors();

  const ctx = canvas.getContext("2d");
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // üö´ hanya 1 wajah
  if (detections.length !== 1) {
    log.innerHTML = "‚ö†Ô∏è Hadapkan SATU wajah ke kamera";
    eyeCloseCount = 0;
    return setTimeout(scan, 150);
  }

  const det = detections[0];
  const best = matcher.findBestMatch(det.descriptor);

  // üö´ wajah tidak dikenal
  if (best.label === "unknown") {
    log.innerHTML = "‚ùå Wajah tidak dikenal";
    return setTimeout(scan, 150);
  }

  // tampilkan nama
  const box = det.detection.box;
  ctx.fillStyle = "lime";
  ctx.font = "20px Arial";
  ctx.fillText(best.label, box.x + 5, box.y - 10);

  // =====================
  // DETEKSI KEDIP
  // =====================
  const leftEye = det.landmarks.getLeftEye();
  const rightEye = det.landmarks.getRightEye();

  const ear = (eyeEAR(leftEye) + eyeEAR(rightEye)) / 2;
  console.log("EAR:", ear.toFixed(3));

  if (ear < 0.21) {
    eyeCloseCount++;
  } else {
    if (eyeCloseCount >= 2) {
      blinked = true;
      log.innerHTML = "üëÅÔ∏è Kedip terdeteksi";
    }
    eyeCloseCount = 0;
  }

  // absensi
  if (blinked) {
    absen(best.label);
    blinked = false;
  }

  setTimeout(scan, 150);
}

/* ===============================
   START SISTEM
================================ */
async function start() {
  log.innerHTML = "‚è≥ Memuat model AI...";
  await Promise.all([
    faceapi.nets.tinyFaceDetector.loadFromUri("models"),
    faceapi.nets.faceLandmark68Net.loadFromUri("models"),
    faceapi.nets.faceRecognitionNet.loadFromUri("models")
  ]);

  log.innerHTML = "‚è≥ Memuat data wajah...";
  const data = await fetch("faces.json").then(r => r.json());

  const labeled = data.map(p =>
    new faceapi.LabeledFaceDescriptors(
      p.name + " | " + p.nis,
      p.descriptors.map(d => new Float32Array(d))
    )
  );

  matcher = new faceapi.FaceMatcher(labeled, 0.7);

  log.innerHTML = "üì∑ Mengaktifkan kamera...";
  const stream = await navigator.mediaDevices.getUserMedia({
    video: { width: 720, height: 480 }
  });

  video.srcObject = stream;
  video.onplaying = () => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    log.innerHTML = "üî• Sistem siap ‚Äî KEDIPKAN MATA";
    scan();
  };
}

start();
</script>

</body>
</html>
