
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Absensi Wajah Cepat</title>
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <style>
    video { width: 420px; border:1px solid black; }
    canvas { position:absolute; left:0; top:0; }
  </style>
</head>
<body>
<h3>Absensi Wajah Otomatis (Optimasi Cepat)</h3>

<div style="position:relative;">
  <video id="cam" autoplay muted></video>
  <canvas id="canvas"></canvas>
</div>

<div id="log" style="margin-top:20px; font-size:18px; color:green;"></div>

<script>
  let lastEAR = 0;
let blinked = false;

const video = document.getElementById("cam");
const canvas = document.getElementById("canvas");
const log = document.getElementById("log");
let matcher;
let absensi = {};  // anti absensi berulang

/* -----------------------------
   SIMPAN ABSENSI
------------------------------*/
function absen(nama) {
  if (absensi[nama]) return;            // sudah absen? stop
  absensi[nama] = true;                 // catat sudah absen
  log.innerHTML = "‚úî Absensi: <b>" + nama + "</b> (" + new Date().toLocaleTimeString() + ")";
  console.log("ABSEN:", nama);
}

/* -----------------------------
   DETEKSI LOOP
------------------------------*/
 async function scan() {
  const detections = await faceapi
    .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
    .withFaceLandmarks()
    .withFaceDescriptors();

  const ctx = canvas.getContext("2d");
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // üö´ Batasi 1 wajah saja
  if (detections.length !== 1) {
    log.innerHTML = "‚ö†Ô∏è Hadapkan 1 wajah saja ke kamera";
    return setTimeout(scan, 500);
  }

  const det = detections[0];
  const best = matcher.findBestMatch(det.descriptor);
  const box = det.detection.box;

  // Gambar nama
  ctx.fillStyle = "lime";
  ctx.font = "22px Arial";
  ctx.fillText(best.label, box.x + 5, box.y - 10);

  // üö´ Wajah tidak dikenal
  if (best.label === "unknown") {
    log.innerHTML = "‚ùå Wajah tidak dikenal";
    return setTimeout(scan, 500);
  }

  // =====================
  // DETEKSI KEDIP
  // =====================
  const leftEye = det.landmarks.getLeftEye();
  const rightEye = det.landmarks.getRightEye();

  const ear =
    (eyeEAR(leftEye) + eyeEAR(rightEye)) / 2;

  // threshold aman
  if (ear < 0.22 && lastEAR >= 0.22) {
    blinked = true;
    log.innerHTML = "üëÅÔ∏è Kedip terdeteksi";
  }

  lastEAR = ear;

  // ‚úÖ Absensi hanya jika kedip
  if (blinked) {
    absen(best.label);
    blinked = false;
  }

  setTimeout(scan, 500);
}




  /* kedip  */
function distance(p1, p2) {
  return Math.hypot(p1.x - p2.x, p1.y - p2.y);
}

function eyeEAR(eye) {
  const A = distance(eye[1], eye[5]);
  const B = distance(eye[2], eye[4]);
  const C = distance(eye[0], eye[3]);
  return (A + B) / (2.0 * C);
}

  
/* -----------------------------
   MULAI
------------------------------*/
async function start() {
  log.innerHTML = "‚è≥ Loading model...";
  await Promise.all([
    faceapi.nets.tinyFaceDetector.loadFromUri("models"),
    faceapi.nets.faceLandmark68Net.loadFromUri("models"),
    faceapi.nets.faceRecognitionNet.loadFromUri("models")
  ]);
  log.innerHTML = "‚è≥ Loading data wajah...";

  const data = await fetch("faces.json").then(r => r.json());
  const labeled = data.map(p => {
  // buat label: "Muhlis | 0003"
  const labelGabungan = p.name + " | " + p.nis;

  return new faceapi.LabeledFaceDescriptors(
    labelGabungan,
    p.descriptors.map(d => new Float32Array(d))
  );
});
  matcher = new faceapi.FaceMatcher(labeled, 0.7);
 // matcher = new faceapi.FaceMatcher(labeled, 0.45);
  log.innerHTML = "üì∑ Mengaktifkan kamera...";

  navigator.mediaDevices.getUserMedia({ video: { width:720, height:480 } })
    .then(stream => {
      video.srcObject = stream;
      video.onplaying = () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        log.innerHTML = "üî• Sistem siap ‚Äî tampilkan wajah untuk absensi";
        scan();
      };
    });
}

start();
</script>
</body>
</html>
